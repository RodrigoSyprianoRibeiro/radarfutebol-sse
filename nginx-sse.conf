# Configuração Nginx para SSE Go - Radar Futebol
# Adicionar este bloco dentro do server {} do site radarfutebol.com
#
# Arquivo: /etc/nginx/sites-available/radarfutebol
# Localização: dentro do bloco server { ... } após as outras locations

# Upstream para o servidor SSE Go
upstream sse_go {
    server 127.0.0.1:3005;
    keepalive 100;  # Conexões persistentes para melhor performance
}

# SSE Go - Painel e Home
# Adicionar dentro do bloco server {}:
location /sse/ {
    # Proxy para o servidor Go
    proxy_pass http://sse_go;
    proxy_http_version 1.1;

    # Headers para SSE
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection '';

    # CRÍTICO: Desabilitar buffering para SSE
    proxy_buffering off;
    proxy_cache off;
    chunked_transfer_encoding on;

    # Timeouts longos para conexões SSE (2 horas)
    proxy_read_timeout 7200s;
    proxy_send_timeout 7200s;
    proxy_connect_timeout 60s;

    # Evitar que o Nginx feche conexões idle
    keepalive_timeout 7200s;

    # Headers para o cliente
    add_header X-Accel-Buffering no;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# Health check do SSE Go (opcional, para monitoramento)
location = /sse/health {
    proxy_pass http://sse_go/sse/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    # Health check pode ter cache curto
    proxy_cache_valid 200 5s;
}

# Stats do SSE Go (opcional, para monitoramento)
location = /stats {
    # Restringir acesso apenas para admin/interno
    # allow 127.0.0.1;
    # deny all;

    proxy_pass http://sse_go/stats;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
